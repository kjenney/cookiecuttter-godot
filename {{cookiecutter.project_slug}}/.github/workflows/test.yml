name: Run Unit Tests

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  GODOT_VERSION: "{{ cookiecutter.godot_version }}"

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    name: Unit Tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Godot binary
        id: cache-godot
        uses: actions/cache@v4
        with:
          path: |
            godot
            .godot
          key: {% raw %}godot-${{ env.GODOT_VERSION }}-${{ runner.os }}{% endraw %}

          restore-keys: |
            {% raw %}godot-${{ env.GODOT_VERSION }}-{% endraw %}


      - name: Download Godot Engine
        if: {% raw %}steps.cache-godot.outputs.cache-hit != 'true'{% endraw %}

        run: |
          # Determine Godot download URL based on version
          GODOT_URL="https://github.com/godotengine/godot/releases/download/{% raw %}${{ env.GODOT_VERSION }}{% endraw %}-stable/Godot_v{% raw %}${{ env.GODOT_VERSION }}{% endraw %}-stable_linux.x86_64.zip"

          # Download and extract
          wget -q $GODOT_URL -O godot.zip
          unzip -q godot.zip
          chmod +x Godot_v{% raw %}${{ env.GODOT_VERSION }}{% endraw %}-stable_linux.x86_64
          mv Godot_v{% raw %}${{ env.GODOT_VERSION }}{% endraw %}-stable_linux.x86_64 godot

      - name: Verify GUT installation
        run: |
          if [ ! -d "addons/gut" ]; then
            echo "ERROR: GUT addon not found!"
            echo "Please install GUT to the addons/gut directory."
            echo "See: https://github.com/bitwes/Gut"
            exit 1
          fi
          echo "GUT addon found âœ“"

      - name: Import project
        run: |
          # Import the project (generates .godot/imported assets)
          ./godot --headless --editor --quit || true
          sleep 5

      - name: Run unit tests
        id: run-tests
        run: |
          # Run GUT tests in headless mode
          ./godot --headless --path . -s addons/gut/gut_cmdln.gd -gexit 2>&1 | tee test_output.log

          # Check exit code
          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$EXIT_CODE" >> {% raw %}$GITHUB_OUTPUT{% endraw %}

          # Parse results
          if grep -q "All tests passed" test_output.log; then
            echo "âœ“ All tests passed!"
            echo "test_result=success" >> {% raw %}$GITHUB_OUTPUT{% endraw %}

          elif grep -q "Tests Failed" test_output.log; then
            echo "âœ— Some tests failed"
            echo "test_result=failure" >> {% raw %}$GITHUB_OUTPUT{% endraw %}

          else
            echo "âš  Could not determine test status"
            echo "test_result=unknown" >> {% raw %}$GITHUB_OUTPUT{% endraw %}

          fi

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: test_output.log
          retention-days: 7

      - name: Test summary
        if: always()
        run: |
          echo "## Test Results ðŸ§ª" >> {% raw %}$GITHUB_STEP_SUMMARY{% endraw %}

          echo "" >> {% raw %}$GITHUB_STEP_SUMMARY{% endraw %}


          if [ "{% raw %}${{ steps.run-tests.outputs.test_result }}{% endraw %}" == "success" ]; then
            echo "âœ… All tests passed!" >> {% raw %}$GITHUB_STEP_SUMMARY{% endraw %}

          elif [ "{% raw %}${{ steps.run-tests.outputs.test_result }}{% endraw %}" == "failure" ]; then
            echo "âŒ Some tests failed. Check the logs for details." >> {% raw %}$GITHUB_STEP_SUMMARY{% endraw %}

          else
            echo "âš ï¸ Test status unknown. Check the logs." >> {% raw %}$GITHUB_STEP_SUMMARY{% endraw %}

          fi

          echo "" >> {% raw %}$GITHUB_STEP_SUMMARY{% endraw %}

          echo "See the full logs in the artifacts." >> {% raw %}$GITHUB_STEP_SUMMARY{% endraw %}


      - name: Fail if tests failed
        if: {% raw %}steps.run-tests.outputs.exit_code != '0'{% endraw %}

        run: |
          echo "Tests failed with exit code {% raw %}${{ steps.run-tests.outputs.exit_code }}{% endraw %}"
          exit 1
